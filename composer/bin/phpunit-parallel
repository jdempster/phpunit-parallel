#!/usr/bin/env php
<?php

$binaryName = PHP_OS_FAMILY === 'Windows' ? 'phpunit-parallel.exe' : 'phpunit-parallel';
$binaryPath = dirname(__DIR__) . '/.binary/' . $binaryName;

if (!file_exists($binaryPath)) {
    fwrite(STDERR, "phpunit-parallel: binary not found at {$binaryPath}\n");
    fwrite(STDERR, "Run 'composer install' or 'composer update' to download the binary.\n");
    exit(1);
}

$args = array_slice($argv, 1);

if (PHP_OS_FAMILY !== 'Windows' && function_exists('pcntl_exec')) {
    pcntl_exec($binaryPath, $args);
    // pcntl_exec only returns on failure
    fwrite(STDERR, "phpunit-parallel: failed to execute binary\n");
    exit(1);
}

$escaped = array_map('escapeshellarg', $args);
$command = escapeshellarg($binaryPath) . ' ' . implode(' ', $escaped);
passthru($command, $exitCode);
exit($exitCode);
